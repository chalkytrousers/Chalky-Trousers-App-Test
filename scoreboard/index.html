<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="manifest" href="manifest.json?v=49">
    <meta name="theme-color" content="#000000">
    <title>Chalky Trousers Scoreboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #000000;
            --banner-bg: #111111;
            --accent-green: #22ff6d;
            --accent-red-subtle: rgba(255, 68, 68, 0.2);
            --border-color: rgba(255, 255, 255, 0.1);
            --middle-width: clamp(85px, 13vw, 140px);
            --nav-h: 32px;
            --name-h: 44px;
            --footer-h: 12px; /* Height of the very bottom black bar */
            --mid-gap: 1.5vh;
            --label-fs: 0.7rem;
            --logo-mh: 65px; 
            --spring-min: 10px;
        }

        @media screen and (min-aspect-ratio: 21/10) {
            :root {
                --middle-width: 170px; 
                --name-h: 60px;       
                --footer-h: 18px;
                --mid-gap: 2.5vh;     
                --label-fs: 0.9rem;  
                --logo-mh: 100px;
                --spring-min: 20px;
            }
        }

        * { 
            box-sizing: border-box; 
            user-select: none !important; 
            -webkit-user-select: none !important; 
            -webkit-touch-callout: none !important; 
            -webkit-tap-highlight-color: transparent; 
            touch-action: pan-y;
        }

        body, html {
            margin: 0; padding: 0; 
            height: 100dvh; width: 100vw;
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at center, #1a1a1a 0%, #000000 100%);
            color: white; font-family: 'Chakra Petch', sans-serif;
            overflow: hidden; position: fixed;
        }

        .main-wrapper {
            display: flex; flex-direction: column; 
            height: 100dvh; width: 100%;
            /* env handles the physical screen cutouts */
            padding: 0 env(safe-area-inset-right) 0 env(safe-area-inset-left);
        }

        .top-nav {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 10px; height: var(--nav-h);
            border-bottom: 1px solid var(--border-color); flex-shrink: 0;
            margin-top: env(safe-area-inset-top);
        }

        .logo-text { font-size: 0.65rem; font-weight: 700; color: rgba(255,255,255,0.4); text-transform: uppercase; }
        .nav-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); color: #888; padding: 1px 8px; border-radius: 4px; font-size: 0.6rem; cursor: pointer; }
        .nav-btn.reset { background: var(--accent-red-subtle); border: 1px solid rgba(255, 68, 68, 0.3); color: white; }
        .nav-btn.undo { border-color: var(--accent-green); color: var(--accent-green); font-weight: 700; }

        .names-banner { display: flex; height: var(--name-h); background: var(--banner-bg); border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .name-slot { 
            flex: 1; display: flex; justify-content: center; align-items: center; 
            font-size: clamp(1.2rem, 3.8vw, 3.2rem); font-weight: 900; 
            text-transform: uppercase; color: #bbb; overflow: hidden; white-space: nowrap; outline: none;
        }
        .name-slot:focus { color: var(--accent-green); background: rgba(255,255,255,0.05); }
        .name-spacer { width: var(--middle-width); background: rgba(0,0,0,0.8); }

        .scores-area { display: flex; flex: 1; width: 100%; overflow: hidden; }
        .score-pane { flex: 1; display: flex; justify-content: center; align-items: center; }

        .middle-banner {
            width: var(--middle-width); 
            display: grid;
            grid-template-rows: auto auto minmax(var(--spring-min), 1fr) auto;
            background: rgba(0,0,0,0.8);
            border-left: 1px solid var(--border-color); 
            border-right: 1px solid var(--border-color);
            flex-shrink: 0;
            padding-top: 15px;
        }

        .middle-section { text-align: center; width: 100%; padding: 0 5px; }
        .middle-label { 
            font-size: var(--label-fs); font-weight: 900; color: #f0f0f0; 
            text-transform: uppercase; margin-bottom: 2px; letter-spacing: 0.08rem;
            text-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        
        .break-arrow-svg { width: 42px; height: 42px; fill: var(--accent-green); filter: drop-shadow(0 0 8px rgba(34, 255, 109, 0.6)); transition: transform 0.3s ease; }
        .flipped { transform: scaleX(-1); }

        .details-group { display: flex; flex-direction: column; gap: var(--mid-gap); margin-top: 15px; }
        .mid-select {
            background: #1a1a1a; border: 1px solid #444; color: #fff; padding: 4px 0; border-radius: 4px;
            font-family: inherit; font-size: 0.8rem; font-weight: 700; width: 92%; 
            appearance: none; -webkit-appearance: none; text-align: center; text-align-last: center;
        }

        .spacer-spring { width: 100%; }

        .middle-logo { 
            width: 100%; max-height: var(--logo-mh); height: auto; 
            opacity: 0.95; object-fit: contain; margin: 0 auto;
            display: block; padding: 0 8px 10px 8px; /* Added padding to bottom to lift off banner */
        }
        
        .score-num { 
            font-size: clamp(7rem, 28vw, 33rem); font-weight: 700; line-height: 0.85; 
            text-shadow: 0 0 30px rgba(0,0,0,0.6); cursor: pointer; transition: color 0.1s ease;
        }

        /* NEW BOTTOM BANNER */
        .bottom-banner {
            height: var(--footer-h);
            background: #000000;
            width: 100%;
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
            padding-bottom: env(safe-area-inset-bottom); /* Essential for Android Nav bar area */
        }

        #orientation-overlay { display: none; position: fixed; inset: 0; background: #000; z-index: 10000; flex-direction: column; justify-content: center; align-items: center; }
        @media screen and (orientation: portrait) { #orientation-overlay { display: flex; } .main-wrapper { display: none; } }
    </style>
</head>
<body>
    <div id="orientation-overlay"><h2>ROTATE TO LANDSCAPE</h2></div>
    
    <div class="main-wrapper">
        <header class="top-nav">
            <div class="logo-text">WWW.CHALKYTROUSERS.CO.UK</div>
            <div style="display:flex; gap:10px;">
                <button class="nav-btn undo" id="undo-btn" style="display:none;" onclick="undoReset()">Undo</button>
                <button class="nav-btn" id="fs-btn" style="display:none;" onclick="toggleFS()">â›¶ Fullscreen</button>
                <button class="nav-btn reset" onclick="resetMatch()">Reset</button>
            </div>
        </header>

        <nav class="names-banner">
            <div class="name-slot" id="p1-txt" contenteditable="true" spellcheck="false" oninput="limitName(this)">PLAYER 1</div>
            <div class="name-spacer"></div>
            <div class="name-slot" id="p2-txt" contenteditable="true" spellcheck="false" oninput="limitName(this)">PLAYER 2</div>
        </nav>

        <main class="scores-area">
            <section class="score-pane">
                <div class="score-num" id="s1" onpointerdown="scStart(event, 's1')" onpointerup="scEnd(event, 's1')" onpointerleave="scCancel('s1')">0</div>
            </section>
            
            <section class="middle-banner">
                <div class="middle-section">
                    <div class="middle-label">BREAK</div>
                    <div id="arrow-wrap" onclick="toggleBreak()">
                        <svg id="svg-arrow" class="break-arrow-svg" viewBox="0 0 24 24"><path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"/></svg>
                    </div>
                </div>

                <div class="details-group">
                    <div class="middle-section">
                        <div class="middle-label">RACE TO</div>
                        <select id="race-to-select" class="mid-select" onchange="save()">
                            <option value="-">-</option>
                        </select>
                    </div>
                    <div class="middle-section">
                        <div class="middle-label">RULES</div>
                        <select id="ruleset-select" class="mid-select" onchange="save()">
                            <option value="uk8">uk8</option>
                            <option value="wpa">wpa</option>
                            <option value="ultimate">ultimate</option>
                            <option value="custom">custom</option>
                        </select>
                    </div>
                </div>

                <div class="spacer-spring"></div>

                <img id="logo-img" src="https://chalkytrousers.github.io/Chalky-Trousers-App-Android/assets/ct-logo-text.png?v=205" class="middle-logo" alt="Logo">
            </section>

            <section class="score-pane">
                <div class="score-num" id="s2" onpointerdown="scStart(event, 's2')" onpointerup="scEnd(event, 's2')" onpointerleave="scCancel('s2')">0</div>
            </section>
        </main>

        <footer class="bottom-banner"></footer>
    </div>

    <script>
        const KEY = 'ct_v8_data';
        let breakSide = 1;
        let lastScores = null;
        let lastBreakSide = null;
        let undoTimeout = null;

        function save() {
            const d = {
                s1: document.getElementById('s1').innerText,
                s2: document.getElementById('s2').innerText,
                p1: document.getElementById('p1-txt').innerText.trim(),
                p2: document.getElementById('p2-txt').innerText.trim(),
                side: breakSide,
                rules: document.getElementById('ruleset-select').value,
                race: document.getElementById('race-to-select').value
            };
            localStorage.setItem(KEY, JSON.stringify(d));
        }

        function load() {
            const s = localStorage.getItem(KEY);
            if (s) {
                const d = JSON.parse(s);
                document.getElementById('s1').innerText = d.s1 || "0";
                document.getElementById('s2').innerText = d.s2 || "0";
                document.getElementById('p1-txt').innerText = d.p1 || "PLAYER 1";
                document.getElementById('p2-txt').innerText = d.p2 || "PLAYER 2";
                breakSide = d.side || 1;
                updateArrow();
                document.getElementById('ruleset-select').value = d.rules || "uk8";
                document.getElementById('race-to-select').value = d.race || "-";
            }
        }

        function limitName(el) {
            if (el.innerText.length > 15) {
                const selection = window.getSelection();
                const range = selection.getRangeAt(0);
                const offset = range.startOffset;
                el.innerText = el.innerText.substring(0, 15);
                const newRange = document.createRange();
                newRange.setStart(el.childNodes[0] || el, Math.min(offset, 15));
                newRange.collapse(true);
                selection.removeAllRanges();
                selection.addRange(newRange);
            }
            save();
        }

        document.querySelectorAll('.name-slot').forEach(slot => {
            slot.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { e.preventDefault(); slot.blur(); }
            });
        });

        function toggleBreak() { breakSide = breakSide === 1 ? 2 : 1; updateArrow(); save(); }
        function updateArrow() { const a = document.getElementById('svg-arrow'); if (breakSide === 1) a.classList.remove('flipped'); else a.classList.add('flipped'); }
        
        let holdT, isHold = false;
        function scStart(e, id) { if (e.cancelable) e.preventDefault(); isHold = false; holdT = setTimeout(() => { isHold = true; upd(id, -1); flash(id, '#ff4444'); }, 600); }
        function scEnd(e, id) { clearTimeout(holdT); if (!isHold) { upd(id, 1, true); flash(id, '#22ff6d'); } }
        function scCancel(id) { clearTimeout(holdT); }

        function upd(id, n, isWin = false) { 
            const el = document.getElementById(id); 
            let v = parseInt(el.innerText) + n; 
            el.innerText = v < 0 ? 0 : v; 
            if (isWin && n > 0) toggleBreak();
            else save(); 
        }

        function flash(id, c) { const el = document.getElementById(id); const o = el.style.color; el.style.color = c; setTimeout(() => el.style.color = o, 200); }

        function resetMatch() {
            lastScores = { s1: document.getElementById('s1').innerText, s2: document.getElementById('s2').innerText };
            lastBreakSide = breakSide;
            document.getElementById('s1').innerText = "0";
            document.getElementById('s2').innerText = "0";
            save();
            const ub = document.getElementById('undo-btn');
            ub.style.display = 'block';
            clearTimeout(undoTimeout);
            undoTimeout = setTimeout(() => { ub.style.display = 'none'; }, 5000);
        }

        function undoReset() {
            if (lastScores) {
                document.getElementById('s1').innerText = lastScores.s1;
                document.getElementById('s2').innerText = lastScores.s2;
                breakSide = lastBreakSide;
                updateArrow();
                lastScores = null;
                document.getElementById('undo-btn').style.display = 'none';
                save();
            }
        }

        function toggleFS() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else document.exitFullscreen();
        }

        window.addEventListener('load', () => {
            const raceSel = document.getElementById('race-to-select');
            for(let i=1; i<=21; i++) {
                let opt = document.createElement('option');
                opt.value = i; opt.innerText = i;
                raceSel.appendChild(opt);
            }
            load();
            if (!window.matchMedia('(display-mode: standalone)').matches) {
                document.getElementById('fs-btn').style.display = 'block';
            }
        });

        window.oncontextmenu = (e) => { if(e.target.classList.contains('score-num')) { e.preventDefault(); return false; } };
    </script>
</body>
</html>
